<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{head :: head}">
    <!-- Fallback content -->
</head>
<body>
<link rel="stylesheet" th:href="@{/css/invoice-numbering-style.css}">
    <div class="container mt-5">
        <div class="card">
            <div class="container my-auto mx-auto">
                <!-- Page Header -->
                <h2 class="text-center mb-4">Invoice Numbering Settings</h2>
                <p class="text-muted text-center">Configure how your invoice numbers are generated</p>

                <!-- Navigation Buttons -->
                <div class="mb-3">
                    <button type="button" class="nav-button" onclick="window.location.href='/';">Back to Main</button>
                    <button type="button" class="nav-button ms-2" onclick="window.location.href='/invoices/items';">Back to Invoice</button>
                    <button type="button" class="nav-button ms-2"
                            th:if="${currentUser != null and currentUser.defaultSeller != null}"
                            th:onclick="'window.location.href=\'/sellers/edit/' + ${currentUser.defaultSeller.id} + '\';'">Back to Seller</button>
                </div>

        <!-- Alert Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            ‚úì <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            ‚úó <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Current Seller Context -->
        <div class="alert alert-info">
            <strong>Company:</strong>
            <span th:text="${currentUser != null and currentUser.defaultSeller != null} ? ${currentUser.defaultSeller.name} : 'No seller assigned'"></span>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="numberingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="configure-tab" data-bs-toggle="tab"
                        data-bs-target="#configure" type="button" role="tab">
                    Configure Numbering
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab"
                        data-bs-target="#history" type="button" role="tab">
                    Numbering History
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content border border-top-0 p-4" id="numberingTabsContent">

            <!-- Tab 1: Configure Numbering -->
            <div class="tab-pane fade show active" id="configure" role="tabpanel">

                <!-- Current Active Scheme Summary -->
                <div th:if="${!activeSchemes.isEmpty()}" class="current-scheme-box mb-4"
                     id="currentSchemeBanner"
                     th:attr="data-template=${activeSchemes[0].template},data-reset=${activeSchemes[0].resetPeriod}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Current scheme:</strong>
                            <code th:text="${activeSchemes[0].template}" class="ms-2"></code>
                            <span class="text-muted ms-2">¬∑</span>
                            <span class="text-muted ms-1" th:text="${activeSchemes[0].resetPeriod.description}"></span>
                            <span class="text-muted ms-2">¬∑</span>
                            <span class="text-muted ms-1">effective from
                                <strong th:text="${#temporals.format(activeSchemes[0].effectiveFrom, 'dd/MM/yyyy')}"></strong>
                            </span>
                        </div>
                        <button type="button" class="nav-button" onclick="loadCurrentScheme()">
                            Load into editor
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        ‚Üì Saving a new scheme below will automatically replace this one.
                    </small>
                </div>

                <div th:if="${activeSchemes.isEmpty()}" class="alert alert-info mb-4">
                    No active scheme yet. Configure your first invoice numbering scheme below.
                </div>

                <!-- Live Preview (above form for quick feedback) -->
                <div class="preview-box mb-4">
                    <div class="preview-label">
                        üëÅÔ∏è LIVE PREVIEW - Next 3 Invoice Numbers
                    </div>
                    <div id="livePreview" class="preview-number"
                         th:attr="data-active-template=${!activeSchemes.isEmpty() ? activeSchemes[0].template : ''},data-active-reset=${!activeSchemes.isEmpty() ? activeSchemes[0].resetPeriod : ''}">
                        <div id="preview1" class="mb-1">---</div>
                        <div id="preview2" class="mb-1 text-muted">---</div>
                        <div id="preview3" class="text-muted">---</div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Preview updates in real-time as you edit
                    </small>
                </div>

                <form th:action="@{/settings/invoice-numbering/create}" method="post" th:object="${newScheme}">

                    <!-- Step 1: Choose Format -->
                    <div class="form-section mb-4">
                        <h3>1. Choose Format</h3>

                        <!-- Preset Gallery -->
                        <div class="preset-gallery">
                            <!-- 1. Most popular: Prefix Monthly -->
                            <div class="preset-card" data-template="INV-{SEQ:3}-{MM}-{YYYY}" data-reset="MONTHLY">
                                <div class="preset-example">INV-001-01-2026</div>
                                <div class="preset-name">Prefix Monthly</div>
                                <div class="preset-desc">Prefix-Sequence-Month-Year</div>
                            </div>

                            <!-- 2. Standard Monthly -->
                            <div class="preset-card" data-template="{SEQ:3}-{MM}-{YYYY}" data-reset="MONTHLY">
                                <div class="preset-example">001-01-2026</div>
                                <div class="preset-name">Standard Monthly</div>
                                <div class="preset-desc">Sequence-Month-Year</div>
                            </div>

                            <!-- 3. Year First -->
                            <div class="preset-card" data-template="{YYYY}-{MM}-{SEQ:3}" data-reset="MONTHLY">
                                <div class="preset-example">2026-01-001</div>
                                <div class="preset-name">Year First</div>
                                <div class="preset-desc">Year-Month-Sequence</div>
                            </div>

                            <!-- 4. Prefix Yearly -->
                            <div class="preset-card" data-template="INV-{SEQ:3}-{YYYY}" data-reset="YEARLY">
                                <div class="preset-example">INV-001-2026</div>
                                <div class="preset-name">Prefix Yearly</div>
                                <div class="preset-desc">Prefix-Sequence-Year</div>
                            </div>

                            <!-- 5. Custom Format -->
                            <div class="preset-card custom-card" id="customCard">
                                <div class="preset-example">‚úé</div>
                                <div class="preset-name">Custom Format</div>
                                <div class="preset-desc">Design your own</div>
                            </div>
                        </div>

                        <!-- Custom Template Editor -->
                        <div id="customTemplateEditor" style="display: none;">
                            <label class="form-label" for="templateInput">Custom Template:</label>
                            <input type="text" id="templateInput"
                                   class="form-control mb-3" placeholder="e.g., INV-{SEQ:3}-{YYYY}">

                            <div class="token-help">
                                <strong>Available Tokens:</strong>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <code class="token">{SEQ:3}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">001, 002, 003...</span>
                                            <small class="d-block text-muted">Sequence number with 3 digits</small>
                                        </div>
                                        <div class="mb-2">
                                            <code class="token">{YYYY}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">2026</span>
                                            <small class="d-block text-muted">Full year (4 digits)</small>
                                        </div>
                                        <div class="mb-2">
                                            <code class="token">{YY}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">26</span>
                                            <small class="d-block text-muted">Short year (2 digits)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <code class="token">{MM}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">01, 02...12</span>
                                            <small class="d-block text-muted">Month with zero-padding</small>
                                        </div>
                                        <div class="mb-2">
                                            <code class="token">{M}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">1, 2...12</span>
                                            <small class="d-block text-muted">Month without padding</small>
                                        </div>
                                        <div class="mb-2">
                                            <code class="token">{DEPT}</code>
                                            <span class="text-muted">‚Üí</span>
                                            <span class="text-success">IT, HR, FIN</span>
                                            <small class="d-block text-muted">Department code (optional)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2 mb-0">
                                    üí°
                                    <strong>Tip:</strong> Any text outside <code>{...}</code> is literal.
                                    Example: <code>INV-{SEQ:3}</code> produces <code>INV-001</code>, <code>INV-002</code>, etc.
                                </div>
                            </div>

                            <!-- Department Preview (optional) -->
                            <div class="mt-3">
                                <label class="form-label" for="deptPreviewInput">Test with Department Code (optional):</label>
                                <input type="text" id="deptPreviewInput" class="form-control"
                                       placeholder="e.g., IT, HR, FIN" maxlength="10">
                                <small class="text-muted">Only for preview - not saved with scheme</small>
                            </div>
                        </div>

                        <!-- Hidden field for template (filled by presets or custom) -->
                        <input type="hidden" id="selectedTemplate" th:field="*{template}">
                    </div>

                    <!-- Step 2: Reset Period -->
                    <div class="form-section mb-4">
                        <h3>2. Reset Period</h3>
                        <select class="form-select" id="resetPeriodSelect" th:field="*{resetPeriod}" required>
                            <option value="">-- Select when to reset sequence --</option>
                            <option th:each="period : ${resetPeriods}"
                                    th:value="${period}"
                                    th:text="${period.description}"></option>
                        </select>
                    </div>

                    <!-- Step 3: Effective Date -->
                    <div class="form-section mb-4">
                        <h3>3. Effective From</h3>
                        <input type="date" class="form-control" th:field="*{effectiveFrom}"
                               required min="2020-01-01">
                        <small class="form-text text-muted">
                            This scheme will apply to all invoices issued on or after this date
                        </small>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="save-button"
                                th:text="${!activeSchemes.isEmpty()} ? 'Save & Replace Current Scheme' : 'Save Numbering Scheme'">
                            Save Numbering Scheme
                        </button>
                        <small th:if="${!activeSchemes.isEmpty()}" class="text-muted text-center">
                            Current active scheme will be automatically archived.
                        </small>
                    </div>
                </form>
            </div>

            <!-- Tab 2: Numbering History -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <h3>All Numbering Schemes</h3>

                <div th:if="${schemes.isEmpty()}" class="alert alert-info">
                    ‚ÑπÔ∏è
                    No numbering schemes configured yet. Create your first scheme in the "Configure Numbering" tab.
                </div>

                <table th:if="${!schemes.isEmpty()}" class="table table-striped history-table">
                    <thead>
                        <tr>
                            <th>Template</th>
                            <th>Reset Period</th>
                            <th>Effective From</th>
                            <th>Ver.</th>
                            <th>Status</th>
                            <th>Created by</th>
                            <th>Created at</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="scheme : ${schemes}"
                            th:class="${scheme.status == T(dev.robgro.timesheet.invoice.SchemeStatus).ACTIVE} ? 'row-active fw-bold' : ''">
                            <td><code th:text="${scheme.template}"></code></td>
                            <td th:text="${scheme.resetPeriod.description}"></td>
                            <td th:text="${#temporals.format(scheme.effectiveFrom, 'dd/MM/yyyy')}"></td>
                            <td th:text="${'v' + scheme.version}"></td>
                            <td>
                                <span th:class="${scheme.status == T(dev.robgro.timesheet.invoice.SchemeStatus).ACTIVE} ? 'status-badge status-active' : 'status-badge status-archived'"
                                      th:text="${scheme.status}"></span>
                            </td>
                            <td th:text="${scheme.createdByUsername}"></td>
                            <td th:text="${#temporals.format(scheme.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            </div>
        </div>
    </div>
    </div>
    <script th:src="@{/js/invoice-numbering.js}"></script>
</body>
</html>
