#!/bin/bash
# Git commit-msg hook
# Enforces COMMIT_RULES.md format
# Location: .githooks/commit-msg

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
first_line=$(echo "$commit_msg" | head -n 1)

# ANSI colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "üîç Validating commit message against COMMIT_RULES.md..."
echo ""

# Check 1: Subject line length
subject_length=${#first_line}
if [ $subject_length -gt 72 ]; then
    echo -e "${RED}‚ùå REJECTED: Subject line too long${NC}"
    echo -e "   Length: $subject_length characters (max 72)"
    echo -e "   Subject: $first_line"
    echo ""
    echo -e "${YELLOW}Fix: Shorten your commit message to <= 72 characters${NC}"
    exit 1
fi

# Check 2: Format - type: summary
if ! echo "$first_line" | grep -qE '^(feat|fix|chore|docs|style|refactor|test|build|ci): .+'; then
    echo -e "${RED}‚ùå REJECTED: Invalid commit format${NC}"
    echo -e "   Subject: $first_line"
    echo ""
    echo -e "${YELLOW}Required format: type: short summary${NC}"
    echo ""
    echo "Allowed types:"
    echo "  - feat:     New feature or functionality"
    echo "  - fix:      Bug fix"
    echo "  - chore:    Routine tasks, maintenance"
    echo "  - docs:     Documentation changes"
    echo "  - style:    Code formatting (no logic changes)"
    echo "  - refactor: Code refactoring (no behavior change)"
    echo "  - test:     Adding or modifying tests"
    echo "  - build:    Build system or dependencies"
    echo "  - ci:       CI/CD configuration"
    echo ""
    echo "Examples:"
    echo "  - feat: add invoice generation endpoint"
    echo "  - fix: correct VAT calculation rounding"
    echo "  - refactor: extract expense categorization logic"
    exit 1
fi

# Check 3: No AI attribution
if echo "$commit_msg" | grep -qiE '(Co-Authored-By.*Claude|Generated by Claude|Claude Code)'; then
    echo -e "${RED}‚ùå REJECTED: AI attribution footer detected${NC}"
    echo ""
    echo "Found forbidden text:"
    echo "$commit_msg" | grep -iE '(Co-Authored-By.*Claude|Generated by Claude|Claude Code)'
    echo ""
    echo -e "${YELLOW}Remove AI attribution - commits represent user's work, not AI's${NC}"
    exit 1
fi

# Check 4: Avoid verbose body (warning, not blocking)
line_count=$(echo "$commit_msg" | wc -l)
if [ $line_count -gt 15 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Commit message is verbose ($line_count lines)${NC}"
    echo ""
    echo "COMMIT_RULES.md examples are SHORT:"
    echo "  - feat: add invoice generation endpoint"
    echo "  - fix: correct VAT calculation rounding"
    echo ""
    echo "Consider simplifying (but commit will proceed)."
    echo ""
fi

# Check 5: Forbidden words
if echo "$first_line" | grep -qiE '\b(wip|temp|update|fix stuff|changes)\b'; then
    echo -e "${RED}‚ùå REJECTED: Vague commit message${NC}"
    echo -e "   Subject: $first_line"
    echo ""
    echo -e "${YELLOW}Avoid vague words: wip, temp, update, changes${NC}"
    echo "Be specific about WHAT changed."
    exit 1
fi

# All checks passed
echo -e "${GREEN}‚úÖ Commit message validated successfully${NC}"
echo -e "   Type: $(echo "$first_line" | cut -d':' -f1)"
echo -e "   Length: $subject_length/72 characters"
echo ""

exit 0
