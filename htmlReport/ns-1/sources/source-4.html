


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > FtpService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">dev.robgro.timesheet.service</a>
</div>

<h1>Coverage Summary for Class: FtpService (dev.robgro.timesheet.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">FtpService</td>
<td class="coverageStat">
  <span class="percent">
    4,5%
  </span>
  <span class="absValue">
    (1/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0,9%
  </span>
  <span class="absValue">
    (1/114)
  </span>
</td>
</tr>
  <tr>
    <td class="name">FtpService$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    3,8%
  </span>
  <span class="absValue">
    (1/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0,8%
  </span>
  <span class="absValue">
    (1/118)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package dev.robgro.timesheet.service;
&nbsp;
&nbsp;import dev.robgro.timesheet.exception.FtpException;
&nbsp;import lombok.Getter;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.apache.commons.net.ftp.FTP;
&nbsp;import org.apache.commons.net.ftp.FTPReply;
&nbsp;import org.apache.commons.net.ftp.FTPSClient;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.core.env.Environment;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import javax.net.ssl.TrustManager;
&nbsp;import javax.net.ssl.X509TrustManager;
&nbsp;import java.io.ByteArrayInputStream;
&nbsp;import java.io.ByteArrayOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.security.cert.X509Certificate;
&nbsp;import java.time.Duration;
&nbsp;import java.util.Arrays;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@Getter
&nbsp;public class FtpService {
&nbsp;
<b class="nc">&nbsp;    private final Environment environment;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.server}&quot;)
<b class="nc">&nbsp;    private String server;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.port}&quot;)
<b class="nc">&nbsp;    private int port;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.username}&quot;)
<b class="nc">&nbsp;    private String username;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.password}&quot;)
<b class="nc">&nbsp;    private String password;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.invoices.directory}&quot;)
<b class="nc">&nbsp;    private String invoicesDirectory;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.connection.timeout:10000}&quot;)
<b class="nc">&nbsp;    private int connectionTimeout;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.data.timeout:60000}&quot;)
<b class="nc">&nbsp;    private int dataTimeout;</b>
&nbsp;
&nbsp;    @Value(&quot;${ftp.security.accept-all-certificates:false}&quot;)
&nbsp;    private boolean acceptAllCertificates;
&nbsp;
<b class="nc">&nbsp;    public FtpService(Environment environment) {</b>
<b class="nc">&nbsp;        this.environment = environment;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void uploadPdfInvoice(String fileName, byte[] content) {
<b class="nc">&nbsp;        log.info(&quot;Starting upload of invoice PDF: {}&quot;, fileName);</b>
<b class="nc">&nbsp;        int maxRetries = 3;</b>
<b class="nc">&nbsp;        int retryCount = 0;</b>
<b class="nc">&nbsp;        int backoffMs = 1000;</b>
&nbsp;
<b class="nc">&nbsp;        while (retryCount &lt; maxRetries) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                doUploadPdfInvoice(fileName, content);</b>
&nbsp;                return;
&nbsp;            } catch (IOException e) {
<b class="nc">&nbsp;                retryCount++;</b>
<b class="nc">&nbsp;                if (retryCount &gt;= maxRetries) {</b>
<b class="nc">&nbsp;                    log.error(&quot;Failed to upload PDF after {} attempts&quot;, maxRetries, e);</b>
<b class="nc">&nbsp;                    throw new FtpException(&quot;Failed to upload invoice PDF to FTP after &quot; + maxRetries + &quot; attempts&quot;, e);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                log.warn(&quot;Upload attempt {} failed, retrying in {} ms&quot;, retryCount, backoffMs, e);</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Thread.sleep(backoffMs);</b>
<b class="nc">&nbsp;                    backoffMs *= 2;</b>
&nbsp;                } catch (InterruptedException ie) {
<b class="nc">&nbsp;                    Thread.currentThread().interrupt();</b>
<b class="nc">&nbsp;                    throw new FtpException(&quot;Interrupted during retry&quot;, ie);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void doUploadPdfInvoice(String fileName, byte[] content) throws IOException {
<b class="nc">&nbsp;        FTPSClient ftpsClient = null;</b>
&nbsp;
<b class="nc">&nbsp;        try (ByteArrayInputStream inputStream = new ByteArrayInputStream(content)) {</b>
<b class="nc">&nbsp;            ftpsClient = createFtpsClient();</b>
<b class="nc">&nbsp;            connectToFtp(ftpsClient);</b>
&nbsp;
&nbsp;            // Passive mode ON
<b class="nc">&nbsp;            ftpsClient.enterLocalPassiveMode();</b>
<b class="nc">&nbsp;            ftpsClient.setFileType(FTP.BINARY_FILE_TYPE);</b>
&nbsp;
<b class="nc">&nbsp;            boolean success = ftpsClient.storeFile(invoicesDirectory + &quot;/&quot; + fileName, inputStream);</b>
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;Upload file&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            if (!success) {</b>
<b class="nc">&nbsp;                throw new IOException(&quot;Failed to upload invoice PDF: &quot; + ftpsClient.getReplyString());</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            log.info(&quot;Successfully uploaded invoice PDF: {}&quot;, fileName);</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            disconnect(ftpsClient);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public byte[] downloadPdfInvoice(String fileName) {
<b class="nc">&nbsp;        log.info(&quot;Starting download of invoice PDF: {}&quot;, fileName);</b>
<b class="nc">&nbsp;        int maxRetries = 3;</b>
<b class="nc">&nbsp;        int retryCount = 0;</b>
<b class="nc">&nbsp;        int backoffMs = 1000;</b>
&nbsp;
<b class="nc">&nbsp;        while (retryCount &lt; maxRetries) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                return doDownloadPdfInvoice(fileName);</b>
&nbsp;            } catch (IOException e) {
<b class="nc">&nbsp;                retryCount++;</b>
<b class="nc">&nbsp;                if (retryCount &gt;= maxRetries) {</b>
<b class="nc">&nbsp;                    log.error(&quot;Failed to download PDF after {} attempts&quot;, maxRetries, e);</b>
<b class="nc">&nbsp;                    throw new FtpException(&quot;Failed to download invoice PDF from FTP after &quot; + maxRetries + &quot; attempts&quot;, e);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                log.warn(&quot;Download attempt {} failed, retrying in {} ms&quot;, retryCount, backoffMs, e);</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Thread.sleep(backoffMs);</b>
<b class="nc">&nbsp;                    backoffMs *= 2;</b>
&nbsp;                } catch (InterruptedException ie) {
<b class="nc">&nbsp;                    Thread.currentThread().interrupt();</b>
<b class="nc">&nbsp;                    throw new FtpException(&quot;Interrupted during retry&quot;, ie);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        throw new FtpException(&quot;Unexpected code path in downloadPdfInvoice&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private byte[] doDownloadPdfInvoice(String fileName) throws IOException {
<b class="nc">&nbsp;        FTPSClient ftpsClient = null;</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            ftpsClient = createFtpsClient();</b>
<b class="nc">&nbsp;            connectToFtp(ftpsClient);</b>
&nbsp;
<b class="nc">&nbsp;            ftpsClient.enterLocalPassiveMode();</b>
<b class="nc">&nbsp;            ftpsClient.setFileType(FTP.BINARY_FILE_TYPE);</b>
&nbsp;
<b class="nc">&nbsp;            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</b>
<b class="nc">&nbsp;            boolean success = ftpsClient.retrieveFile(</b>
&nbsp;                    invoicesDirectory + &quot;/&quot; + fileName,
&nbsp;                    outputStream
&nbsp;            );
&nbsp;
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;Download file&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            if (!success) {</b>
<b class="nc">&nbsp;                throw new FtpException(&quot;Failed to download invoice PDF: &quot; + ftpsClient.getReplyString());</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            log.info(&quot;Successfully downloaded invoice PDF: {}&quot;, fileName);</b>
<b class="nc">&nbsp;            return outputStream.toByteArray();</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            disconnect(ftpsClient);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private FTPSClient createFtpsClient() {
<b class="nc">&nbsp;        FTPSClient ftpsClient = new FTPSClient(false); // Explicit mode</b>
&nbsp;
<b class="nc">&nbsp;        ftpsClient.setEnabledProtocols(new String[]{&quot;TLSv1.2&quot;, &quot;TLSv1.3&quot;});</b>
&nbsp;
<b class="nc">&nbsp;        ftpsClient.setConnectTimeout(connectionTimeout);</b>
<b class="nc">&nbsp;        ftpsClient.setDefaultTimeout(connectionTimeout);</b>
<b class="nc">&nbsp;        ftpsClient.setDataTimeout(Duration.ofMillis(dataTimeout));</b>
&nbsp;
<b class="nc">&nbsp;        if (isAcceptAllCertificates()) {</b>
<b class="nc">&nbsp;            ftpsClient.setTrustManager(createAllTrustingManager());</b>
<b class="nc">&nbsp;            ftpsClient.setHostnameVerifier((hostname, session) -&gt; true);</b>
<b class="nc">&nbsp;            log.warn(&quot;Using insecure certificate validation - NOT FOR PRODUCTION USE&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return ftpsClient;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void connectToFtp(FTPSClient ftpsClient) throws IOException {
<b class="nc">&nbsp;        log.debug(&quot;Connecting to FTP server: {}:{}&quot;, server, port);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            ftpsClient.connect(server, port);</b>
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;Connect&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            int reply = ftpsClient.getReplyCode();</b>
<b class="nc">&nbsp;            if (!FTPReply.isPositiveCompletion(reply)) {</b>
<b class="nc">&nbsp;                String errorMsg = &quot;Failed to connect to FTP server. Reply code: &quot; + reply;</b>
<b class="nc">&nbsp;                log.error(errorMsg);</b>
<b class="nc">&nbsp;                throw new IOException(errorMsg);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (!ftpsClient.login(username, password)) {</b>
<b class="nc">&nbsp;                logFtpResponse(ftpsClient, &quot;Login&quot;);</b>
<b class="nc">&nbsp;                String errorMsg = &quot;Failed to login to FTP server. Invalid credentials.&quot;;</b>
<b class="nc">&nbsp;                log.error(errorMsg);</b>
<b class="nc">&nbsp;                throw new IOException(errorMsg);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;Login&quot;);</b>
&nbsp;
&nbsp;            // Protection Buffer Size
<b class="nc">&nbsp;            ftpsClient.execPBSZ(0);</b>
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;PBSZ&quot;);</b>
&nbsp;
&nbsp;            //  Data Channel Protection Level (private)
<b class="nc">&nbsp;            ftpsClient.execPROT(&quot;P&quot;);</b>
<b class="nc">&nbsp;            logFtpResponse(ftpsClient, &quot;PROT&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            log.debug(&quot;Successfully connected to FTP server&quot;);</b>
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            log.error(&quot;Failed to connect to FTP server: {}:{} - {}&quot;, server, port, e.getMessage());</b>
<b class="nc">&nbsp;            throw new FtpException(&quot;Connection to FTP server failed: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void disconnect(FTPSClient ftpsClient) {
<b class="nc">&nbsp;        if (ftpsClient == null) {</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            if (ftpsClient.isConnected()) {</b>
<b class="nc">&nbsp;                ftpsClient.logout();</b>
<b class="nc">&nbsp;                logFtpResponse(ftpsClient, &quot;Logout&quot;);</b>
<b class="nc">&nbsp;                ftpsClient.disconnect();</b>
<b class="nc">&nbsp;                log.debug(&quot;Disconnected from FTP server&quot;);</b>
&nbsp;            }
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            log.warn(&quot;Error disconnecting from FTP server&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean isAcceptAllCertificates() {
<b class="nc">&nbsp;        return acceptAllCertificates &amp;&amp; !isProductionEnvironment();</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isProductionEnvironment() {
<b class="nc">&nbsp;        return Arrays.asList(environment.getActiveProfiles()).contains(&quot;prod&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isDevelopmentEnvironment() {
<b class="nc">&nbsp;        return Arrays.asList(environment.getActiveProfiles()).contains(&quot;dev&quot;) ||</b>
<b class="nc">&nbsp;                Arrays.asList(environment.getActiveProfiles()).contains(&quot;local&quot;) ||</b>
<b class="nc">&nbsp;                Arrays.asList(environment.getDefaultProfiles()).contains(&quot;default&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private TrustManager createAllTrustingManager() {
<b class="nc">&nbsp;        return new X509TrustManager() {</b>
&nbsp;            public X509Certificate[] getAcceptedIssuers() {
<b class="nc">&nbsp;                return null;</b>
&nbsp;            }
&nbsp;
&nbsp;            public void checkClientTrusted(X509Certificate[] certs, String authType) {
<b class="nc">&nbsp;            }</b>
&nbsp;
&nbsp;            public void checkServerTrusted(X509Certificate[] certs, String authType) {
<b class="nc">&nbsp;            }</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private void logFtpResponse(FTPSClient ftpsClient, String operation) {
<b class="nc">&nbsp;        log.debug(&quot;{} result: {} - {}&quot;,</b>
&nbsp;                operation,
<b class="nc">&nbsp;                ftpsClient.getReplyCode(),</b>
<b class="nc">&nbsp;                ftpsClient.getReplyString().trim());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-04-18 14:51</div>
</div>
</body>
</html>
